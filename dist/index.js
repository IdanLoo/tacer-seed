"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var readline=require("readline"),handlebars=_interopDefault(require("handlebars")),path=require("path"),fs=require("fs"),unzipper=_interopDefault(require("unzipper")),stream=require("stream"),fsExtra=require("fs-extra"),archiver=_interopDefault(require("archiver"));function __rest(e,t){var r={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(e);n<i.length;n++)t.indexOf(i[n])<0&&(r[i[n]]=e[i[n]])}return r}function __awaiter(e,t,r,i){return new(r||(r=Promise))(function(n,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){e.done?n(e.value):new r(function(t){t(e.value)}).then(a,s)}u((i=i.apply(e,t||[])).next())})}function line(e,t=""){return __awaiter(this,void 0,void 0,function*(){const r=readline.createInterface({input:process.stdin,output:process.stdout});return t&&(e+=`(${t}) `),(yield new Promise((t,i)=>r.question(e,e=>{r.close(),t(e)})))||t})}class Template{constructor(e){var t=__rest(e,[]);Object.assign(this,t)}render(e){return handlebars.compile(e)(this)}static fromStdin(e,t){var r=__rest(t,[]);return __awaiter(this,void 0,void 0,function*(){const t=yield line("package name: ",r.name),i=yield line("version: ","0.1.0"),n=yield line("description: "),o=yield line("git repository: "),a=yield line("author: "),s=yield line("license: ","MIT");return new this({template:e,name:t,version:i,description:n,repository:o,author:a,license:s})})}}function dirname(e){return path.resolve(e).split("/").pop()}function copy(e,t){return __awaiter(this,void 0,void 0,function*(){if("Directory"===e.type)return void(yield fsExtra.mkdirs(t));yield fsExtra.createFile(t);const r=e.pipe(fsExtra.createWriteStream(t));return new Promise((e,t)=>{r.on("finish",e).on("error",t)})})}function unzip(e,t,r){return __awaiter(this,void 0,void 0,function*(){const i=fs.createReadStream(e);if(!r)return i.pipe(unzipper.Extract({path:t})).promise();const n=new stream.Transform({objectMode:!0,transform:(e,i,n)=>__awaiter(this,void 0,void 0,function*(){if(!(yield r(e)))return yield e.autodrain().promise(),n();const i=path.join(t,e.path);copy(e,i).then(n)})}),o=i.pipe(unzipper.Parse()).pipe(n);return new Promise((e,t)=>{o.on("finish",e).on("error",t)})})}function combine(e){return __awaiter(this,void 0,void 0,function*(){const t=[];return e.on("data",e=>{t.push(e)}),new Promise((r,i)=>{e.on("end",()=>r(t.join(""))).on("error",i)})})}function generate(e,t,r){return __awaiter(this,void 0,void 0,function*(){const i=dirname(r),n=yield Template.fromStdin(e,{name:i});yield unzip(t,r,e=>__awaiter(this,void 0,void 0,function*(){if(!e.path.endsWith(".tpl"))return!0;const t=path.join(r,e.path.split(/\.tpl$/).shift()),i=yield combine(e).then(e=>n.render(e));yield fsExtra.outputFile(t,i)}))})}function zip(e,t){return __awaiter(this,void 0,void 0,function*(){const r=fs.createWriteStream(t),i=archiver("zip");return i.pipe(r),i.directory(e,!1),i.finalize(),new Promise((e,t)=>{i.on("error",t).on("finish",e)})})}exports.default=generate,exports.unzip=unzip,exports.zip=zip;
